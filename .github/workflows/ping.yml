# =============================== 
# GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# Render ã‚¢ãƒ—ãƒªã‚’æŒ‡å®šæ™‚é–“ã«ãƒ©ãƒ³ãƒ€ãƒ ã§ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ â†’ 5åˆ†å¾Œã«å†åº¦ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
# ===============================

name: Scheduled Health Check to Render

on:
  schedule:
    # JSTæŒ‡å®šæ™‚é–“ â†’ UTCå¤‰æ›æ¸ˆã¿
    - cron: "30 23 * * *" # JST 8:30
    - cron: "00 03 * * *" # JST 12:00
    - cron: "00 09 * * *" # JST 18:00
    - cron: "40 15 * * *" # JST 0:30
  
jobs:
  health_check:
    runs-on: ubuntu-latest
    steps:
      - name: Random delay and double health check
        run: |
          echo "ğŸš€ Render Scheduled Health Check"

          # ãƒ©ãƒ³ãƒ€ãƒ é…å»¶ã‚’ç”Ÿæˆï¼ˆÂ±10åˆ†ï¼‰
          OFFSET=$(( RANDOM % 1200 - 600 ))

          if [ $OFFSET -gt 0 ]; then
            echo "â³ Waiting $OFFSET seconds before first health check..."
            sleep $OFFSET
          else
            echo "â­ï¸ Skipping wait (negative offset: $OFFSET ç§’)"
          fi

          # JST ç¾åœ¨æ™‚åˆ»ã‚’å‡ºåŠ›ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
          NOW_JST_H=$(TZ=Asia/Tokyo date +"%H")
          NOW_JST_M=$(TZ=Asia/Tokyo date +"%M")
          echo "â° ç¾åœ¨ã® JST: ${NOW_JST_H}:${NOW_JST_M}"

          TARGET_URL="https://line-bot-1-rsyx.onrender.com/health"

          # --- 1å›ç›®ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ ---
          echo "âœ… First health check to $TARGET_URL"
          curl --retry 5 --retry-delay 5 -fsS --max-time 30 "$TARGET_URL" \
            || echo "âš ï¸ First health check failed"

          # --- 5åˆ†å¾…æ©Ÿ ---
          echo "â³ Waiting 300 seconds (5 minutes) before second health check..."
          sleep 300

          # --- 2å›ç›®ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ ---
          echo "âœ… Second health check to $TARGET_URL"
          curl --retry 5 --retry-delay 5 -fsS --max-time 30 "$TARGET_URL" \
            || echo "âš ï¸ Second health check failed"

          echo "âœ… Both health checks completed"
