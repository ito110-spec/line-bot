# ===============================
# GitHub Actions ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# Render ã‚¢ãƒ—ãƒªã‚’æŒ‡å®šæ™‚é–“ã«ãƒ©ãƒ³ãƒ€ãƒ  ping ã—ã¦èµ·å‹•ã•ã›ã‚‹
# æ¯æ—¥ 8:30, 12:00, 18:00 Â±10åˆ†ãƒ©ãƒ³ãƒ€ãƒ 
# ===============================

name: Scheduled Random Ping to Render

on:
  schedule:
    # JSTæŒ‡å®šæ™‚é–“ â†’ UTCå¤‰æ›æ¸ˆã¿
    - cron: "30 23 * * *" # JST 8:30
    - cron: "30 03 * * *" # JST 12:00
    - cron: "30 09 * * *" # JST 18:00

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Random delay and ping
        run: |
          echo "ğŸš€ Render Scheduled Ping"

          # Â±10åˆ†ãƒ©ãƒ³ãƒ€ãƒ é…å»¶ï¼ˆ600ç§’ï¼‰
          OFFSET=$(( RANDOM % 1200 - 600 )) # -600ã€œ+599ç§’
          echo "â³ Waiting $OFFSET seconds before ping..."
          sleep $OFFSET

          # JST ç¾åœ¨æ™‚åˆ»ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
          NOW_JST_H=$(TZ=Asia/Tokyo date +"%H")
          NOW_JST_M=$(TZ=Asia/Tokyo date +"%M")
          echo "â° ç¾åœ¨ã® JST: ${NOW_JST_H}:${NOW_JST_M}"

          # Render å¥åº·ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã« ping
          TARGET_URL="https://line-bot-1-rsyx.onrender.com/health"
          echo "âœ… Pinging $TARGET_URL"

          curl --retry 5 --retry-delay 5 -fsS --max-time 30 "$TARGET_URL" || echo "âš ï¸ Ping failed"
