# =============================== 
# GitHub Actions ワークフロー
# Render アプリを指定時間にランダム ping → 5分後に再度 ping
# ===============================

name: Scheduled Random Ping to Render

on:
  schedule:
    # JST指定時間 → UTC変換済み
    - cron: "30 23 * * *" # JST 8:30
    - cron: "00 03 * * *" # JST 12:00
    - cron: "00 09 * * *" # JST 18:00
    - cron: "30 15 * * *"
  
jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Random delay and double ping
        run: |
          echo "🚀 Render Scheduled Ping"

          # ランダム遅延を生成（±10分）
          OFFSET=$(( RANDOM % 1200 - 600 ))

          if [ $OFFSET -gt 0 ]; then
            echo "⏳ Waiting $OFFSET seconds before first ping..."
            sleep $OFFSET
          else
            echo "⏭️ Skipping wait (negative offset: $OFFSET 秒)"
          fi

          # JST 現在時刻を出力（デバッグ用）
          NOW_JST_H=$(TZ=Asia/Tokyo date +"%H")
          NOW_JST_M=$(TZ=Asia/Tokyo date +"%M")
          echo "⏰ 現在の JST: ${NOW_JST_H}:${NOW_JST_M}"

          TARGET_URL="https://line-bot-1-rsyx.onrender.com/health"

          # --- 1回目の ping ---
          echo "✅ First ping to $TARGET_URL"
          curl --retry 5 --retry-delay 5 -fsS --max-time 30 "$TARGET_URL" \
            || echo "⚠️ First ping failed"

          # --- 5分待機 ---
          echo "⏳ Waiting 300 seconds (5 minutes) before second ping..."
          sleep 300

          # --- 2回目の ping ---
          echo "✅ Second ping to $TARGET_URL"
          curl --retry 5 --retry-delay 5 -fsS --max-time 30 "$TARGET_URL" \
            || echo "⚠️ Second ping failed"

          echo "✅ Both pings completed"
